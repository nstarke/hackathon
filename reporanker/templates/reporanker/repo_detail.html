{% extends 'reporanker/base.html' %}
{% load staticfiles %}

{% block body_content %}
  <div class="detail-container">
    <div class="detail-header">
	    <p><span class="detail-name"><a href="{{ object.html_url }}">{{ object.name }}</a></span> <span class="detail-description">{% if object.description%} - {{object.description}} {% endif %}</span></p>
    </div>

    <div class="detail-body">
      Owner: {{ object.owner_name }}<br/>
      Language: {{ object.language }}<br/>
      {% if object.get_average_octocats %}
      Octocats: {{ object.get_average_octocats }}<br/>
      {% endif %}
      <div>
        <span class="octocon octocon-stars"></span> {{ object.star_count }}
        <span class="octocon octocon-eye-watch"></span> {{ object.watchers_count }}
        <span class="octocon octocon-forks"></span>  {{ object.forks_count }}
        <span class="octocon octocon-issues"></span> {{ object.open_issue_count }}
      </div>
      <div class="octo-icon-detail">
        {% if average_octocats %}
          <span><img src="{% static 'reporanker/img/octo_32_black.png' %}" alt="octo_cat">= {{average_octocats}}</p></span>
        {% endif %}
      </div>
    </div>
  </div>

    {% if not user_reviewed %}
    <div class="detail-review-none">
      <p>There are no reviews yet <a href="{% url 'repo-review-view' object.id %}">Click to be the first!  </a></p>
    </div>
    {% endif %}

    {% for review in object.ordered_review_set.all|slice:":10" %}
      <div class="detail-review">
        <strong>Reviewer:</strong> {{review.user}}<br/>
        <strong>Octocat Rating:</strong> {{review.octocats}}<br/>
        <div class="review-votes">
          {% if not review.reviewopinion_set.all %}
              <script type="text/javascript">
              var voteResult = "none";
              </script>
          {% endif %}
          {% for opinion in review.reviewopinion_set.all %}
            {% if opinion and opinion.user == request.user %}
              {% if not opinion.helpful %}
              <script type="text/javascript">
              var voteResult = "down";
              </script>
              {% else %}
              <script type="text/javascript">
              var voteResult = "up";
              </script>
              {% endif %}
            {% endif %}
          {% endfor %}
          <div id="not-voted">
            <button id='upvote' name='upvote' class="upvote-btn" style="border: 0; background: transparent" onclick='vote("up", {{review.pk}})'><i class="icon glyphicon glyphicon-thumbs-up"></i></button>
            <button id='downvote' name='downvote' class="downvote-btn" style="border: 0; background: transparent" onclick='vote("down", {{review.pk}});'><i class="icon glyphicon glyphicon-thumbs-down"></i></button>
          </div>
          <div id="down-voted">
            <button id='upvote' name='upvote' class="upvote-btn" style="border: 0; background: transparent" onclick='vote("up", {{review.pk}})'><i class="icon glyphicon glyphicon-thumbs-up"></i></button>
            <button id='downvoted' name='downvoted' class="downvote-btn" style="border: 0; background: transparent"><i class="icon glyphicon glyphicon-thumbs-down"></i></button>
          </div>
          <div id="up-voted">
            <button id='upvoted' name='upvoted' class="upvote-btn" style="border: 0; background: transparent"><i class="icon glyphicon glyphicon-thumbs-up"></i></button>
            <button id='downvote' name='downvote' class="downvote-btn" style="border: 0; background: transparent" onclick='vote("down", {{review.pk}});'><i class="icon glyphicon glyphicon-thumbs-down"></i></button>
          </div>
        </div>
        <strong>Comment:</strong> {{review.comment}}<br/>
      </div>
    {% endfor %}

{% endblock %}

{% block script %}
    <script type="text/javascript">
      var toggleResult = function (){
        if (voteResult === "up"){
          $('#up-voted').show()
          $('#not-voted').hide()
          $('#down-voted').hide()
        } else if (voteResult === "down"){
          $('#up-voted').hide()
          $('#not-voted').hide()
          $('#down-voted').show()
        } else if (voteResult === "none"){
          $('#up-voted').show()
          $('#not-voted').hide()
          $('#down-voted').hide()
        }
      }
      toggleResult();

      var token = '{{csrf_token}}';
      var vote = function(vote_verb, review){
        $.ajax({
          type: "POST",
          url: "/repo/rep/",
          data: {
            "vote": vote_verb,
            "review": review,
            "csrfmiddlewaretoken": token
          },
          success: function(response){
            if (vote_verb === "down"){
              voteResult = "down";
              toggleResult();
            } else if (vote_verb === "up"){
              voteResult = "up";
              toggleResult();
            }
          }
        });
      };
    </script>
{% endblock %}
